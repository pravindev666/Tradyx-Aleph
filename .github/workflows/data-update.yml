name: Update Dashboard Data

on:
  schedule:
    # Run every 15 minutes during market hours (IST: 9:15 AM - 3:30 PM)
    # UTC: 3:45 AM - 10:00 AM (IST is UTC+5:30)
    # Schedule: 9:15, 9:30, 9:45, 10:00, 10:15, 10:30, 10:45, 11:00, 11:15, 11:30, 11:45, 12:00,
    #           12:15, 12:30, 12:45, 13:00, 13:15, 13:30, 13:45, 14:00, 14:15, 14:30, 14:45, 15:00, 15:15, 15:30 IST
    # UTC equivalents: 3:45, 4:00, 4:15, 4:30, 4:45, 5:00, 5:15, 5:30, 5:45, 6:00, 6:15, 6:30,
    #                  6:45, 7:00, 7:15, 7:30, 7:45, 8:00, 8:15, 8:30, 8:45, 9:00, 9:15, 9:30, 9:45, 10:00 UTC
    - cron: '45 3 * * 1-5'           # 3:45 UTC = 9:15 IST
    - cron: '0,15,30,45 4-9 * * 1-5' # 4:00-9:45 UTC = 9:30-15:15 IST (every 15 min)
    - cron: '0 10 * * 1-5'           # 10:00 UTC = 15:30 IST
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  TZ: Asia/Kolkata

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'tradyx-options-dashboard/scripts/requirements.txt'
      
      - name: Install Python dependencies
        run: |
          cd tradyx-options-dashboard/scripts
          pip install --cache-dir ~/.cache/pip -r requirements.txt
      
      - name: Run data generation scripts
        run: |
          cd tradyx-options-dashboard/scripts
          python run_all.py
        env:
          TZ: Asia/Kolkata
      
      - name: Commit and push updated data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only the public data file (Vercel serves from public/)
          git add tradyx-options-dashboard/public/data/dashboard.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update dashboard data [skip ci]"
            git push origin HEAD:main || git push origin HEAD:master
            echo "âœ… Data updated and pushed to repository"
          fi
        continue-on-error: true
