name: Update Dashboard Data

on:
  schedule:
    # Run every 15 minutes during market hours (IST: 9:15 AM - 3:30 PM)
    # UTC: 3:45 AM - 10:00 AM (IST is UTC+5:30)
    # Using compact pattern: start at 3:45, then every 15 min from 4:00-9:45, then 10:00
    - cron: '45 3 * * 1-5'                # 3:45 UTC = 9:15 IST (start)
    - cron: '0,15,30,45 4-9 * * 1-5'      # Every 15 min from 4:00-9:45 UTC (9:30-15:15 IST)
    - cron: '0 10 * * 1-5'                # 10:00 UTC = 15:30 IST (end)
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  TZ: Asia/Kolkata

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Prevent multiple runs from overlapping
    concurrency:
      group: update-dashboard-data
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'tradyx-options-dashboard/scripts/requirements.txt'
      
      - name: Install Python dependencies
        run: |
          cd tradyx-options-dashboard/scripts
          pip install --cache-dir ~/.cache/pip -r requirements.txt
      
      - name: Run data generation scripts
        run: |
          cd tradyx-options-dashboard/scripts
          python run_all.py
        env:
          TZ: Asia/Kolkata
      
      - name: Commit and push updated data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only the public data file (Vercel serves from public/)
          git add tradyx-options-dashboard/public/data/dashboard.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update dashboard data [skip ci]"
            git push origin HEAD:main || git push origin HEAD:master
            echo "âœ… Data updated and pushed to repository"
          fi
        continue-on-error: true
