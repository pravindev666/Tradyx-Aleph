name: Update Dashboard Data

on:
  schedule:
    # Run every 15 minutes during market hours (IST: 9:15 AM - 3:30 PM)
    # UTC: 3:45 AM - 10:00 AM (IST is UTC+5:30)
    # Using compact pattern: start at 3:45, then every 15 min from 4:00-9:45, then 10:00
    - cron: '45 3 * * 1-5'                # 3:45 UTC = 9:15 IST (start)
    - cron: '0,15,30,45 4-9 * * 1-5'      # Every 15 min from 4:00-9:45 UTC (9:30-15:15 IST)
    - cron: '0 10 * * 1-5'                # 10:00 UTC = 15:30 IST (end)
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  TZ: Asia/Kolkata

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Prevent multiple runs from overlapping
    concurrency:
      group: update-dashboard-data
      cancel-in-progress: false
    
    # Explicitly grant permissions for git push
    permissions:
      contents: write  # Required to push commits
      pull-requests: read  # Optional, for PR comments if needed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use default GITHUB_TOKEN (no need to specify, it's automatic)
          fetch-depth: 0
          submodules: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'tradyx-options-dashboard/scripts/requirements.txt'
      
      - name: Install Python dependencies
        run: |
          cd tradyx-options-dashboard/scripts
          pip install --cache-dir ~/.cache/pip -r requirements.txt
      
      - name: Run data generation scripts
        run: |
          cd tradyx-options-dashboard/scripts
          python run_all.py
          
          # Verify dashboard.json was created
          echo "üîç Verifying dashboard.json was created..."
          if [ -f "../public/data/dashboard.json" ]; then
            echo "‚úÖ dashboard.json exists in public/data/"
            echo "üìä File size: $(wc -c < ../public/data/dashboard.json) bytes"
            echo "üìÖ File timestamp: $(stat -c %y ../public/data/dashboard.json 2>/dev/null || stat -f %Sm ../public/data/dashboard.json 2>/dev/null || echo 'unknown')"
            # Show first few lines to verify it's valid JSON
            head -n 5 ../public/data/dashboard.json
          else
            echo "‚ùå ERROR: dashboard.json NOT FOUND in public/data/"
            echo "üìÅ Listing public/data/ directory:"
            ls -la ../public/data/ || echo "Directory does not exist"
            exit 1
          fi
        env:
          TZ: Asia/Kolkata
      
      - name: Commit and push updated data
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Verify data file exists before committing
          DATA_FILE="tradyx-options-dashboard/public/data/dashboard.json"
          if [ ! -f "$DATA_FILE" ]; then
            echo "‚ùå ERROR: $DATA_FILE does not exist!"
            echo "üìÅ Listing public/data/ directory:"
            ls -la tradyx-options-dashboard/public/data/ || echo "Directory does not exist"
            exit 1
          fi
          
          echo "üìä Checking data file status..."
          echo "File size: $(wc -c < $DATA_FILE) bytes"
          echo "File exists: ‚úÖ"
          
          # Show current git status
          echo "üìã Git status before add:"
          git status --short || true
          
          # Add the public data file (Cloudflare Pages serves from public/)
          git add "$DATA_FILE"
          
          # Touch a file in base directory to ensure Cloudflare detects changes
          # This forces Cloudflare Pages to rebuild even if only data changed
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > tradyx-options-dashboard/.build-trigger
          
          # Also update a version file in the app directory to force rebuild
          echo "{\"version\":\"$(date +%s)\",\"updated\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > tradyx-options-dashboard/app/.data-version.json
          
          git add tradyx-options-dashboard/.build-trigger
          git add tradyx-options-dashboard/app/.data-version.json
          
          # Show what's staged
          echo "üìã Staged files:"
          git diff --staged --name-only || echo "No staged files"
          
          # Check if data file is in staged changes
          if git diff --staged --name-only | grep -q "dashboard.json"; then
            echo "‚úÖ dashboard.json is staged for commit"
          else
            echo "‚ö†Ô∏è  WARNING: dashboard.json is NOT staged!"
            echo "üìã Checking if file changed:"
            git diff "$DATA_FILE" || echo "No diff (file unchanged or not tracked)"
            # Force add even if unchanged (to ensure it's committed)
            git add -f "$DATA_FILE"
            echo "‚úÖ Force-added dashboard.json"
          fi
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit (all files unchanged)"
            echo "üìã This might mean:"
            echo "   - Data file wasn't updated by Python scripts"
            echo "   - Or data is identical to previous run"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Changes detected, committing..."
            git commit -m "chore: update dashboard data [data refresh]"
            
            # Show what was committed
            echo "üìã Committed files:"
            git show --name-only --oneline HEAD | head -10
            
            # Detect current branch
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "üìå Current branch: $CURRENT_BRANCH"
            
            # Push to current repository
            echo "üöÄ Pushing to origin/$CURRENT_BRANCH..."
            if git push origin "$CURRENT_BRANCH"; then
              echo "‚úÖ Data updated and pushed successfully to origin/$CURRENT_BRANCH"
              echo "üîÑ Cloudflare Pages will auto-deploy on push"
            else
              echo "‚ùå ERROR: Failed to push to origin/$CURRENT_BRANCH"
              echo "üìã Checking git remote configuration..."
              git remote -v
              echo "üìã Checking branch information..."
              git branch -a
              echo "‚ö†Ô∏è  Push failed, but commit was successful. Check repository permissions."
              exit 1
            fi
            
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Trigger Cloudflare Pages rebuild
        if: steps.commit.outputs.changed == 'true'
        run: |
          if [ -n "${{ secrets.CLOUDFLARE_BUILD_HOOK }}" ]; then
            echo "üîÑ Triggering Cloudflare Pages rebuild..."
            curl -X POST -d {} "${{ secrets.CLOUDFLARE_BUILD_HOOK }}"
            echo "‚úÖ Cloudflare Pages rebuild triggered"
          else
            echo "‚ÑπÔ∏è  CLOUDFLARE_BUILD_HOOK secret not set. Cloudflare Pages will auto-deploy on push."
          fi
        continue-on-error: true
