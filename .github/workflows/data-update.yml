name: Update Dashboard Data

on:
  schedule:
    # Run every 15 minutes during market hours (IST: 9:15 AM - 3:30 PM)
    # UTC: 3:45 AM - 10:00 AM (IST is UTC+5:30)
    # Using compact pattern: start at 3:45, then every 15 min from 4:00-9:45, then 10:00
    - cron: '45 3 * * 1-5'                # 3:45 UTC = 9:15 IST (start)
    - cron: '0,15,30,45 4-9 * * 1-5'      # Every 15 min from 4:00-9:45 UTC (9:30-15:15 IST)
    - cron: '0 10 * * 1-5'                # 10:00 UTC = 15:30 IST (end)
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  TZ: Asia/Kolkata

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Prevent multiple runs from overlapping
    concurrency:
      group: update-dashboard-data
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'tradyx-options-dashboard/scripts/requirements.txt'
      
      - name: Install Python dependencies
        run: |
          cd tradyx-options-dashboard/scripts
          pip install --cache-dir ~/.cache/pip -r requirements.txt
      
      - name: Run data generation scripts
        run: |
          cd tradyx-options-dashboard/scripts
          python run_all.py
        env:
          TZ: Asia/Kolkata
      
      - name: Commit and push updated data
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add the public data file (Vercel/Netlify/Cloudflare serve from public/)
          git add tradyx-options-dashboard/public/data/dashboard.json
          
          # Touch a file in base directory to ensure Netlify detects changes
          # This forces Netlify to rebuild even if only data changed
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > tradyx-options-dashboard/.build-trigger
          git add tradyx-options-dashboard/.build-trigger
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: update dashboard data [data refresh]"
            git push origin HEAD:main || git push origin HEAD:master
            echo "‚úÖ Data updated and pushed to repository"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Trigger Netlify rebuild
        if: steps.commit.outputs.changed == 'true'
        run: |
          if [ -n "${{ secrets.NETLIFY_BUILD_HOOK }}" ]; then
            echo "üîÑ Triggering Netlify rebuild..."
            curl -X POST -d {} "${{ secrets.NETLIFY_BUILD_HOOK }}"
            echo "‚úÖ Netlify rebuild triggered"
          else
            echo "‚ö†Ô∏è NETLIFY_BUILD_HOOK secret not set. Netlify will auto-deploy on push."
          fi
        continue-on-error: true
