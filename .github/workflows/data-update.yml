name: Update Dashboard Data

on:
  schedule:
    # Run every 15 minutes during market hours (IST: 9:15 AM - 3:30 PM)
    # UTC: 3:45 AM - 10:00 AM (IST is UTC+5:30)
    # Note: 9:15 AM IST = 3:45 AM UTC, 3:30 PM IST = 10:00 AM UTC
    - cron: '15,30,45 3-9 * * 1-5'  # At :15, :30, :45 past hours 3-9 UTC, Mon-Fri
    - cron: '0,15 10 * * 1-5'        # At :00, :15 past 10 UTC (3:30 PM IST = 10:00 AM UTC)
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  TZ: Asia/Kolkata

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          cd scripts
          pip install -r requirements.txt
      
      - name: Run data generation scripts
        run: |
          cd scripts
          python run_all.py
        env:
          TZ: Asia/Kolkata
      
      - name: Commit and push updated data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only the public data file (Vercel serves from public/)
          git add public/data/dashboard.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update dashboard data [skip ci]"
            git push origin HEAD:main || git push origin HEAD:master
            echo "âœ… Data updated and pushed to repository"
          fi
        continue-on-error: true
